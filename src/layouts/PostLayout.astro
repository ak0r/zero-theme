---
import { render } from "astro:content";
import type { Post } from '@/types';
import { siteConfig } from '@/site.config';
import { resolveImage } from '@/utils/images';
import { generatePostSEO } from '@/utils/seo';
import BaseLayout from '@/layouts/BaseLayout.astro';
import SEO from '@/components/common/SEO.astro';
import LinkedMentions from '@/components/widgets/LinkedMentions.astro';
import ImageWrapper from '@/components/common/ImageWrapper.astro';
import ContainerWrapper from '@/components/layout/ContainerWrapper.astro';
import ContentNavigation from '@/components/widgets/ContentNavigation.astro';
import TableOfContents from '@/components/widgets/TableOfContents.astro';
import { getAllPosts, getAdjacentPosts } from '@/utils/getPosts';
import { getFormattedDate, calculateReadingTime } from '@/utils/commonFunctions';
import Breadcrumbs from '@/components/widgets/Breadcrumbs.astro';
import { getPostBreadcrumbs } from '@/utils/breadcrumbs';
export interface Props {
  post: Post;
}

const { post } = Astro.props;

// Generate SEO data
const seoData = generatePostSEO(post, Astro.url.href);

// Filter posts based on environment
const allPosts = await getAllPosts();

// Process the post content
const { Content, headings = [], remarkPluginFrontmatter } = await render(post);
const readingTime = calculateReadingTime(post.body || '');

// Process image path
let postImage = post.data.image;
if (Array.isArray(postImage)) {
  postImage = postImage[0];
}

const coverImage = resolveImage(postImage);
const coverImageAlt = post.data.imageAlt || `Featured image for post: ${post.data.title}`;

// Table of contents
const hideTOC = post.data.hideTOC === true;
const shouldShowTOC = !hideTOC && siteConfig.tableOfContents.enabled && headings.length > 0;

// Get adjacent posts for navigation
const { prev: prevPost, next: nextPost } = getAdjacentPosts(allPosts, post.id);

// Don't show cover image in content if hideCoverImage is set
const shouldShowCoverImage = coverImage && !post.data.hideCoverImage;

// Generate breadcrumbs for the page
const breadcrumbs = getPostBreadcrumbs(post.id, post.data.title);
---

<BaseLayout>
  <!-- SEO -->
  <SEO data={seoData} slot="seo" />

  <ContainerWrapper class="py-8">
    <!-- Back to previous -->
    <div class="animate">
      <!-- <BackToPrevious href="/posts">Back to Posts</BackToPrevious> -->
      <Breadcrumbs items={breadcrumbs} class="my-6"/>
    </div>

    <div class="relative animate">
      <!-- Post header -->
      <div class="my-8 sm:my-10 space-y-2">
        <div class="flex items-center gap-2 text-sm font-medium text-content-muted">
          <time datetime={post.data.date.toISOString()}>
            {getFormattedDate(post.data.date, "full")}
          </time>
          
          {siteConfig.postOptions.readingTime && readingTime && (
            <>
              <span class="text-content-muted">&bull;</span>
              <span>
                {readingTime.text && readingTime.text !== 'read0' && readingTime.text !== '' 
                  ? readingTime.text 
                  : '1 min read'}
              </span>
            </>
          )}
        </div>

        <h1 class="text-2xl font-bold text-content-primary my-4 leading-tight">
          {post.data.title}
        </h1>
        
        {siteConfig.postOptions.tags && post.data.tags && post.data.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {post.data.tags.map(tag => (
              <a
                href={`/posts/tag/${encodeURIComponent(tag)}`}
                class="inline-block px-2 py-1 text-xs transition-colors duration-300 ease-in-out text-content-subtle rounded-full border border-ui-raised hover:bg-surface-subtle"
              >
                {tag}
              </a>
            ))}
          </div>
        )}
      </div>

      <!-- Cover Image -->
      {shouldShowCoverImage && (
        <div class="mb-10">
          <ImageWrapper
            src={coverImage}
            alt={coverImageAlt}
            class="w-full mb-4 rounded-lg border border-ui-primary shadow-lg"
            fit="contain"
          />
        </div>
      )}

      <!-- Table of Contents -->
      {shouldShowTOC && (
        <div id="toc" class="mb-10">
          <TableOfContents headings={headings} />
        </div>
      )}
    </div>

    <article data-pagefind-body class="animate md-content flex flex-col gap-y-10">
      <meta data-pagefind-filter="collection[content]" content="posts" />
      <meta data-pagefind-meta="title[content]" content={post.data.title} />
      <!-- <meta data-pagefind-meta="description[content]" content={post.data.description} /> -->
      <meta data-pagefind-sort="date[content]" content={post.data.date.toISOString()} />
      
      <!-- Article content -->
      <div class="prose max-w-none" id="post-content">
        <Content />
      </div>
    </article>
    {siteConfig.postOptions.linkedMentions.enabled && (
      <LinkedMentions currentSlug={post.id} />
    )}

    <!-- Post navigation -->
    {siteConfig.postOptions.postNavigation && (prevPost || nextPost) && (
      <ContentNavigation prevEntry={prevPost} nextEntry={nextPost} />
    )}
  </ContainerWrapper>
</BaseLayout>