---
import { siteConfig } from '@/site.config';
import Container from '@/components/layout/ContainerWrapper.astro';
import Icon from '@/components/common/IconWrapper.astro';
import ThemeToggle from '@/components/widgets/ThemeToggle.astro'

const showProfilePicture = siteConfig.profilePicture.enabled && siteConfig.profilePicture.placement === 'header';
const profilePicture = siteConfig.profilePicture;

// Style classes for profile picture in header
const getHeaderProfilePictureClasses = (style: string) => {
  switch (style) {
    case 'circle': return 'w-8 h-8 rounded-full object-cover border-2 border-ui-primary';
    case 'square': return 'w-8 h-8 rounded-lg object-cover border-2 border-ui-primary';
    default: return 'h-8 object-contain'; // none - height constrained, width flexible
  }
};

---

<header id="main-header">
  <Container>
  <!-- <div class="mx-auto px-4 sm:px-6 lg:px-8"> -->
    <div class="flex items-center justify-between h-16">
      <!-- Logo / Site Title / Profile Picture -->
      <div class="flex items-center">
        <a href="/" class="hover:opacity-75 transition-opacity">
          {showProfilePicture ? (
            <img
              src={profilePicture.image}
              alt={profilePicture.alt}
              class={getHeaderProfilePictureClasses(profilePicture.style)}
            />
          ) : (
            <span class="font-semibold text-2xl text-content-primary">
              {siteConfig.title}
            </span>
          )}
        </a>
      </div>

      <!-- Center area with smart navigation -->
      <div class={`flex-1 flex items-center ${ siteConfig.navigation.style === 'minimal' ? 'justify-end' : 'justify-center' }`}> 
        <!-- Smart Navigation (single system with style variants) -->
        {siteConfig.navigation.showNavigation && (  
          <nav class={`hidden md:flex items-center ${  
            siteConfig.navigation.style === 'minimal' ? `space-x-5 ${siteConfig.featureButton === 'none' && !siteConfig.commandPalette.enabled ? '' : 'mr-4'}` : 'space-x-5' }`} aria-label="Main navigation">
            {siteConfig.navigation.pages.map(page => (
              <a 
                href={page.url}
                class={
                  siteConfig.navigation.style === 'minimal' 
                    ? `flex items-center space-x-1 text-sm font-normal transition-colors hover:text-accent text-content-muted`
                    : `flex items-center space-x-1 text-md font-medium transition-colors hover:text-accent text-content-muted`
                }
                target={page.url.startsWith('http') ? '_blank' : undefined}
                aria-label={`Navigate to ${page.title}`}
              >
                <span>{siteConfig.navigation.style === 'minimal' ? page.title.toLowerCase() : page.title}</span>
                {page.url.startsWith('http') && (
                  <Icon name="external-link" class="w-3 h-3 text-content-muted" />
                )}
              </a>
            ))}
          </nav>
        )}
      </div>

      <!-- Action buttons -->
      <div class="flex items-center space-x-2">
        <!-- Feature Button -->
        {siteConfig.featureButton === "mode" && <ThemeToggle />}

        <!-- Mobile menu button (if navigation and mobile menu are enabled) -->
        {siteConfig.navigation.showNavigation && siteConfig.navigation.showMobileMenu && (
          <button
            id="mobile-menu-toggle"
            class="md:hidden p-2 text-content-muted hover:bg-surface-raised rounded-lg transition-colors"
            aria-label="Toggle mobile navigation menu"
            aria-expanded="false"
          >
            <span class="menu-icon">
              <Icon name="menu" class="size-5" />
            </span>
            <span class="close-icon hidden">
              <Icon name="x" class="size-5" />
            </span>
          </button>
        )}
      </div>
    </div>

    <!-- Mobile navigation menu -->
    {siteConfig.navigation.showNavigation && siteConfig.navigation.showMobileMenu && (
      <div id="mobile-menu" 
        class="md:hidden animate hidden z-40 bg-surface-primary py-4 border-t border-ui-primary" 
        role="dialog"
        aria-modal="true"
        aria-label="Mobile navigation menu">
        <nav class="flex flex-col space-y-3">
          {siteConfig.navigation.pages.map(page => (
            <a 
              href={page.url}
              class="flex items-center justify-between px-3 py-2 text-content-muted hover:text-accent hover:bg-surface-raised transition-colors font-medium rounded-md"
              target={page.url.startsWith('http') ? '_blank' : undefined}
              aria-label={`Navigate to ${page.title}`}
            >
              <span>{page.title}</span>
              {page.url.startsWith('http') && (
                <Icon name="external-link" class="w-3 h-3 text-content-muted" />
              )}
            </a>
          ))}
        </nav>
      </div>
    )}
  <!-- </div> -->
  </Container>
</header>

<script>
  // Mobile menu toggle
  document.addEventListener('DOMContentLoaded', () => {
    const menuToggle = document.getElementById('mobile-menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');

    if (menuToggle && mobileMenu) {
      menuToggle.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');

        // Update menu icon and ARIA attribute
        const menuIcon = menuToggle.querySelector('.menu-icon');
        const closeIcon = menuToggle.querySelector('.close-icon');
        
        if (menuIcon && closeIcon) {
          if (mobileMenu.classList.contains('hidden')) {
            menuIcon.classList.remove('hidden');
            closeIcon.classList.add('hidden');
            menuToggle.setAttribute('aria-expanded', 'false');
          } else {
            menuIcon.classList.add('hidden');
            closeIcon.classList.remove('hidden');
            menuToggle.setAttribute('aria-expanded', 'true');
          }
        }
      });
    }

    // Function to close mobile menu
    function closeMobileMenu() {
      if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
        mobileMenu.classList.add('hidden');
        
        // Update menu icon and ARIA attribute
        if (menuToggle) {
          const menuIcon = menuToggle.querySelector('.menu-icon');
          const closeIcon = menuToggle.querySelector('.close-icon');
          if (menuIcon && closeIcon) {
            menuIcon.classList.remove('hidden');
            closeIcon.classList.add('hidden');
            menuToggle.setAttribute('aria-expanded', 'false');
          }
        }
      }
    }

    // Close mobile menu when navigation links are clicked
    const mobileMenuLinks = mobileMenu?.querySelectorAll('nav a');
    mobileMenuLinks?.forEach(link => {
      link.addEventListener('click', () => {
        closeMobileMenu();
      });
    });

    // Make closeMobileMenu globally accessible for other components
    (window as any).closeMobileMenu = closeMobileMenu;

    // Close mobile menu when clicking outside of it
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const isMenuToggle = target.closest('#mobile-menu-toggle');
      const isMobileMenu = target.closest('#mobile-menu');
      
      // If clicking outside the menu and toggle button, close the menu
      if (!isMenuToggle && !isMobileMenu && mobileMenu && !mobileMenu.classList.contains('hidden')) {
        closeMobileMenu();
      }
    });
    
    // Header shadow on scroll
    const header = document.getElementById('main-header');
    if (header) {
      let isScrolled = false;
      
      
      const updateHeaderShadow = () => {
        const scrollY = window.scrollY;
        const shouldHaveShadow = scrollY > 0;
        
        if (shouldHaveShadow !== isScrolled) {
          isScrolled = shouldHaveShadow;
          if (shouldHaveShadow) {
            header.classList.add('shadow-sm');
          } else {
            header.classList.remove('shadow-sm');
          }
        }
      };

      // Initial check
      updateHeaderShadow();
      
      // Listen for scroll events
      window.addEventListener('scroll', updateHeaderShadow, { passive: true });
    }
  });
</script>